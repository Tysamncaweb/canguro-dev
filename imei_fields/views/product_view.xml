<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- view used for product.template only -->
    <record id="imei_product_template" model="ir.ui.view">
        <field name="name">lot.series.imei.button</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="stock.product_template_form_view_procurement_button"/>
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_open_product_lot']" position="replace">
                <!-- <button 
                    string="Lot/Serial Number" type="object"
                    name="action_open_product_lot"
                    class="oe_stat_button"
                    icon="fa-bars"
                    attrs="{'invisible': ['|',('tracking','=','imei'), ('tracking','=','none')]}"
                    groups="stock.group_production_lot"
                /> -->
                <button 
                    string="Lot/Serial Number/IMEI Number" type="object"
                    name="action_open_product_lot"
                    class="oe_stat_button"
                    icon="fa-bars"
                    attrs="{'invisible': [('tracking', '=', 'none')]}" 
                    groups="stock.group_production_lot"
                />
            </xpath>
        </field>
    </record>
    
    <!-- view used for product.product only -->
    <record id="imei_product_product" model="ir.ui.view">
        <field name="name">lot.series.imei.variant.button</field>
        <field name="model">product.product</field>
        <field name="inherit_id" ref="stock.product_form_view_procurement_button"/>
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_open_product_lot']" position="replace">
                <button 
                    string="Lot/Serial Number/IMEI" type="object"
                    name="action_open_product_lot"
                    attrs="{'invisible': [('tracking', '=', 'none')]}"
                    class="oe_stat_button"
                    icon="fa-bars"
                    groups="stock.group_production_lot"
                />
            </xpath>
        </field>
    </record>


<!-- We change the menu for Lots/Serial Numbers -->
    <record id="stock.action_production_lot_form" model="ir.actions.act_window">
        <field name="name">Lotes/Números de serie/IMEI</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">stock.production.lot</field>
        <field name="view_ids"
                   eval="[(5, 0, 0),
                          (0, 0, {'view_mode': 'tree', 'view_id': ref('stock.view_production_lot_tree')}),
                          (0, 0, {'view_mode': 'form', 'view_id': ref('stock.view_production_lot_form')})]"/>
        <field name="search_view_id" ref="stock.search_product_lot_filter"/>
        <field name="context">{'search_default_group_by_product': 1}</field>
        <field name="help" type="html">
          <p class="o_view_nocontent_smiling_face">
            Add a lot/serial number/IMEI
          </p><p>
            This is the list of all the production lots you recorded. When
            you select a lot, you can get the traceability of the products contained in lot.
          </p>
        </field>
    </record>

    <menuitem 
        action="stock.action_production_lot_form"
        name="Lotes/Números de serie/IMEI"
        id="stock.menu_action_production_lot_form"
        parent="stock.menu_stock_inventory_control" 
        groups="stock.group_production_lot"
        sequence="101"/>



    <record id="stock.view_stock_move_nosuggest_operations" model="ir.ui.view">
        <field name="name">stock.move.operations.nosuggest.form</field>
        <field name="model">stock.move</field>
        <field name="priority">1000</field>
        <field name="mode">primary</field>
        <field name="inherit_id" ref="stock.view_stock_move_operations"/>
        <field name="arch" type="xml">
            <field name="move_line_ids" position="replace">
                <field name="move_line_nosuggest_ids" attrs="{'readonly': [('state', 'in', ('done', 'cancel'))]}" context="{'tree_view_ref': 'stock.view_stock_move_line_operation_tree','default_picking_id': picking_id, 'default_move_id': id, 'default_product_id': product_id, 'default_location_id': location_id, 'default_location_dest_id': location_dest_id}">
                    <tree string="Move line nosuggest ids">
                        <field name="location_dest_id"/>
                        <field name="lot_id" string="Lots/Serie Number/IMEI"/>
                        <field name="result_package_id"/>
                        <field name="qty_done"/>
                        <field name="product_uom_id"/>
                    </tree>
                </field>
            </field>
        </field>
    </record>

</odoo>